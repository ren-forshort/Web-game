<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cửa hàng Hoi AE KHTN</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-dark: #171a21;
            --bg-secondary: #1b2838;
            --bg-tertiary: #2a475e;
            --accent-blue: #66c0f4;
            --accent-green: #a4d007;
            --text-main: #c7d5e0;
            --text-muted: #8f98a0;
            --overlay: rgba(0, 0, 0, 0.8);
            --header-height: 90px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            min-height: 100vh;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 5px;
        }

        /* Header */
        header {
            background-color: var(--bg-dark);
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 40px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .brand-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-right: 40px;
            text-decoration: none;
            user-select: none;
            cursor: pointer;
        }

        .brand-logo {
            height: 60px;
            width: auto;
            object-fit: contain;
        }

        .brand-text-col {
            display: flex;
            flex-direction: column;
            justify-content: center;
            line-height: 1.1;
        }

        .brand-small {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 600;
        }

        .brand-main {
            font-size: 26px;
            font-weight: 900;
            color: var(--accent-blue);
            letter-spacing: 1px;
            margin: 2px 0;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            margin-right: auto;
        }

        .nav-link {
            color: var(--text-muted);
            text-decoration: none;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            transition: color 0.2s;
            cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
            color: var(--accent-blue);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .search-container {
            position: relative;
        }

        .search-input {
            background-color: #316282;
            border: 1px solid rgba(0,0,0,0.3);
            border-radius: 3px;
            padding: 8px 12px 8px 35px;
            color: white;
            width: 200px;
            transition: width 0.3s ease;
            outline: none;
        }

        .search-input:focus {
            background-color: white;
            color: black;
            width: 250px;
        }

        .search-icon {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            color: var(--accent-blue);
            pointer-events: none;
        }

        /* Main Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 240px 1fr;
            gap: 30px;
        }

        /* Sidebar */
        .sidebar {
            position: sticky;
            top: 110px;
            height: fit-content;
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .sidebar-title {
            color: var(--accent-blue);
            text-transform: uppercase;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .filter-option {
            display: block;
            color: var(--text-muted);
            padding: 5px 0;
            cursor: pointer;
            transition: color 0.2s;
        }

        .filter-option:hover {
            color: white;
        }

        .filter-option.active {
            color: var(--accent-blue);
            font-weight: bold;
        }

        /* Featured Carousel */
        .featured-section {
            grid-column: 1 / -1;
            margin-bottom: 40px;
            position: relative;
            height: 400px;
            background: var(--bg-dark);
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            overflow: hidden;
        }

        .featured-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            display: flex;
            cursor: pointer;
        }

        .featured-slide.active {
            opacity: 1;
        }

        .featured-image {
            width: 65%;
            height: 100%;
            object-fit: cover;
        }

        .featured-info {
            width: 35%;
            background: #0f131a;
            padding: 30px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .featured-title {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .featured-desc {
            color: var(--text-muted);
            font-size: 14px;
            line-height: 1.5;
        }

        .featured-tags {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .tag {
            background: rgba(255,255,255,0.1);
            padding: 2px 8px;
            font-size: 11px;
            border-radius: 2px;
        }

        /* Game Grid */
        .store-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--bg-tertiary);
            padding-bottom: 10px;
        }

        .section-title {
            font-size: 18px;
            color: white;
            text-transform: uppercase;
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
        }

        .game-card {
            background-color: var(--bg-secondary);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .game-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .card-image-container {
            width: 100%;
            aspect-ratio: 16/9;
            background-color: #000;
            overflow: hidden;
        }

        .card-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.3s;
        }

        .game-info {
            padding: 12px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .game-title {
            font-size: 14px;
            color: #c7d5e0;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .game-tags {
            font-size: 11px;
            color: #384959;
            margin-bottom: 10px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--overlay);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modal-overlay.open {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: #1b2838;
            width: 800px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            border: 1px solid #2a475e;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            border-radius: 4px;
        }

        /* Modal Gallery Styles */
        .modal-gallery-container {
            position: relative;
            height: 400px;
            background-color: #000;
            overflow: hidden;
        }

        .modal-gallery-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            transition: opacity 0.3s;
            background-color: #0f131a;
        }

        .modal-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.5);
            border: none;
            color: white;
            padding: 10px;
            cursor: pointer;
            z-index: 10;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .modal-arrow:hover {
            background: rgba(255,255,255,0.2);
        }

        .modal-arrow.left { left: 10px; }
        .modal-arrow.right { right: 10px; }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0,0,0,0.5);
            border: none;
            color: white;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            z-index: 20;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.2);
        }

        .modal-body {
            padding: 30px 40px;
            position: relative;
            background: #1b2838;
        }

        .modal-title {
            font-size: 32px;
            margin-bottom: 15px;
        }

        .modal-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            font-size: 14px;
            color: var(--accent-blue);
        }

        .modal-desc {
            line-height: 1.6;
            margin-bottom: 30px;
            color: var(--text-main);
            white-space: pre-wrap; /* This makes the text respect new lines/Enter key */
        }

        .buy-action {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-download {
            background: linear-gradient(90deg, #66c0f4 5%, #1b588a 95%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 2px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-shadow: 1px 1px 0px rgba(0,0,0,0.3);
            transition: all 0.2s;
        }

        .btn-download:hover {
            background: linear-gradient(90deg, #4da8e0 5%, #154670 95%);
            transform: scale(1.02);
        }
        
        .btn-play {
            background: linear-gradient(90deg, #75b022 5%, #588a1b 95%);
        }
        .btn-play:hover {
            background: linear-gradient(90deg, #8ed629 5%, #6aa421 95%);
        }
        
        /* Review Section Styles */
        .review-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--bg-tertiary);
        }
        
        .review-input-box {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .star-rating {
            display: flex;
            gap: 5px;
            font-size: 24px;
            cursor: pointer;
        }
        
        .star {
            color: #555;
            transition: color 0.2s;
        }
        
        .star.active {
            color: #FFD700;
        }

        .btn-review {
            align-self: flex-start;
            background: var(--bg-tertiary);
            color: var(--text-main);
            border: none;
            padding: 8px 16px;
            border-radius: 2px;
            cursor: pointer;
        }
        
        .btn-review:hover {
            background: #3d5a73;
        }

        .reviews-list {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 300px;
            overflow-y: auto;
        }

        .user-review-item {
            background: rgba(0,0,0,0.15);
            padding: 10px;
            border-radius: 4px;
        }
        
        .review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 13px;
        }
        
        .review-author {
            font-weight: bold;
            color: var(--accent-blue);
        }
        
        .review-stars {
            color: #FFD700;
        }

        /* Report & Upload Page Styles */
        .report-view {
            display: none;
            max-width: 800px;
            margin: 0 auto;
            background: var(--bg-secondary);
            padding: 40px;
            border-radius: 4px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
        }

        .report-header {
            margin-bottom: 30px;
            border-bottom: 1px solid var(--bg-tertiary);
            padding-bottom: 15px;
        }

        .report-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            color: var(--accent-blue);
            font-weight: 600;
            font-size: 14px;
        }

        .form-input, .form-textarea, .form-select {
            background: var(--bg-dark);
            border: 1px solid var(--bg-tertiary);
            color: var(--text-main);
            padding: 12px;
            border-radius: 4px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            border-color: var(--accent-blue);
        }

        .form-textarea {
            min-height: 150px;
            resize: vertical;
        }

        .btn-submit {
            background: linear-gradient(90deg, #75b022 5%, #588a1b 95%);
            color: #d2efa9;
            border: none;
            padding: 12px;
            border-radius: 2px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            align-self: flex-start;
        }

        .btn-submit:hover {
            background: linear-gradient(90deg, #8ed629 5%, #6aa421 95%);
            color: white;
        }

        /* Drag and Drop Styles */
        .drop-zone {
            border: 2px dashed var(--bg-tertiary);
            padding: 30px;
            text-align: center;
            border-radius: 4px;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            color: var(--text-muted);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .drop-zone:hover, .drop-zone.dragover {
            border-color: var(--accent-blue);
            background: rgba(102, 192, 244, 0.1);
            color: var(--text-main);
        }
        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .preview-item {
            position: relative;
            aspect-ratio: 16/9;
        }
        .preview-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid var(--bg-tertiary);
        }
        .remove-img {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4d4d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Community Styles */
        .community-container {
            display: none;
            max-width: 800px;
            margin: 0 auto;
        }
        .post-creator {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 30px;
            border: 1px solid var(--bg-tertiary);
        }
        .post-feed {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .community-post {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 4px;
            border: 1px solid var(--bg-tertiary);
        }
        .post-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 12px;
            color: var(--text-muted);
        }
        .post-author {
            color: var(--accent-blue);
            font-weight: bold;
            font-size: 14px;
        }
        .post-content {
            color: var(--text-main);
            line-height: 1.5;
            white-space: pre-wrap;
        }
        .post-actions {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            border-top: 1px solid var(--bg-tertiary);
            padding-top: 10px;
            align-items: center;
        }
        .vote-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.2);
            padding: 5px 12px;
            border-radius: 20px;
        }
        .vote-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 2px;
            transition: color 0.2s;
        }
        .vote-btn:hover {
            color: var(--accent-blue);
        }
        .vote-btn.active {
            color: var(--accent-green);
        }
        .vote-btn.down:hover {
            color: #ff4d4d;
        }
        .vote-btn.down.active {
            color: #ff4d4d;
        }
        .vote-count {
            font-weight: bold;
            font-size: 14px;
            color: var(--text-main);
            min-width: 20px;
            text-align: center;
        }
        .reply-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s;
        }
        .reply-btn:hover {
            color: var(--text-main);
        }
        .replies-section {
            margin-top: 15px;
            padding-left: 20px;
            border-left: 2px solid var(--bg-tertiary);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .reply-item {
            background: rgba(255,255,255,0.03);
            padding: 10px;
            border-radius: 4px;
        }
        .reply-form {
            display: none;
            margin-top: 10px;
            flex-direction: column;
            gap: 10px;
            background: rgba(0,0,0,0.1);
            padding: 15px;
            border-radius: 4px;
        }
        .reply-form.open {
            display: flex;
        }
        .loading-text {
            text-align: center; 
            color: var(--text-muted); 
            padding: 20px;
        }

        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }
            .sidebar {
                display: none;
            }
            .featured-section {
                height: auto;
                flex-direction: column;
            }
            .featured-slide {
                position: relative;
                flex-direction: column;
                height: auto;
            }
            .featured-image, .featured-info {
                width: 100%;
            }
        }
    </style>
</head>
<body>

    <!-- Header -->
    <header>
        <div class="brand-container" onclick="switchPage('store', document.querySelector('.nav-link'))">
            <img src="fit logo.png" alt="Logo" class="brand-logo" onerror="this.src='https://placehold.co/60x60/1b2838/66c0f4?text=LOGO'">
            <div class="brand-text-col">
                <span class="brand-small">Hoi AE</span>
                <span class="brand-main">KHTN</span>
                <span class="brand-small">Store</span>
            </div>
        </div>
        <nav class="nav-links">
            <a href="#" class="nav-link active" onclick="switchPage('store', this)">Cửa hàng</a>
            <a href="#" class="nav-link" onclick="switchPage('community', this)">Cộng đồng</a>
            <a href="#" class="nav-link" onclick="switchPage('upload', this)">Đăng game</a>
            <a href="#" class="nav-link" onclick="switchPage('support', this)">Hỗ trợ</a>
            <a href="#" class="nav-link" onclick="switchPage('report', this)">Báo cáo</a>
        </nav>
        <div class="header-actions">
            <div class="search-container">
                <i data-lucide="search" class="search-icon"></i>
                <input type="text" class="search-input" placeholder="tìm kiếm" id="search-input">
            </div>
        </div>
    </header>

    <!-- Main Store View -->
    <div id="store-view" class="container">
        <!-- Featured Carousel -->
        <section class="featured-section" id="featured-carousel">
            <!-- Injected by JS -->
        </section>

        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Thể loại</div>
                <div class="filter-option active" onclick="filterByGenre('All')">Tất cả sản phẩm</div>
                <div class="filter-option" onclick="filterByGenre('Hành động')">Hành động</div>
                <div class="filter-option" onclick="filterByGenre('Nhập vai (RPG)')">Nhập vai (RPG)</div>
                <div class="filter-option" onclick="filterByGenre('Chiến thuật')">Chiến thuật</div>
                <div class="filter-option" onclick="filterByGenre('Phiêu lưu')">Phiêu lưu</div>
                <div class="filter-option" onclick="filterByGenre('Mô phỏng')">Mô phỏng</div>
                <div class="filter-option" onclick="filterByGenre('Thể thao')">Thể thao</div>
                <div class="filter-option" onclick="filterByGenre('Parkour')">Parkour</div>
                <div class="filter-option" onclick="filterByGenre('Đua xe')">Đua xe</div>
            </div>
        </aside>

        <!-- Main Store Content -->
        <main>
            <div class="store-header">
                <div class="section-title">Đang xem <span id="current-genre">Tất cả trò chơi</span></div>
            </div>

            <div class="games-grid" id="games-grid">
                <!-- Games injected here -->
            </div>
        </main>
    </div>

    <!-- Upload Game View -->
    <div id="upload-view" class="report-view">
        <div class="report-header">
            <h1 class="section-title" style="font-size: 24px;">Đăng game mới</h1>
            <p style="color: var(--text-muted); margin-top: 10px;">
                Vui lòng điền đầy đủ thông tin bên dưới để chia sẻ game của bạn.
            </p>
        </div>
        <form class="report-form" onsubmit="submitGame(event)">
            <!-- 1. Tên nhà phát triển / công ty -->
            <div class="form-group">
                <label class="form-label">Tên nhà phát triển / công ty <span style="color:red">*</span></label>
                <input type="text" id="game-dev" class="form-input" placeholder="Ví dụ: Indie Dev Team" required>
            </div>

            <!-- 2. Email liên hệ -->
            <div class="form-group">
                <label class="form-label">Email liên hệ <span style="color:red">*</span></label>
                <input type="email" id="game-email" class="form-input" placeholder="contact@example.com" required>
            </div>

            <!-- 3. Tên game -->
            <div class="form-group">
                <label class="form-label">Tên game <span style="color:red">*</span></label>
                <input type="text" id="game-title" class="form-input" placeholder="Nhập tên trò chơi" required>
            </div>
            
            <!-- 4. Mô tả ngắn -->
            <div class="form-group">
                <label class="form-label">Mô tả ngắn <span style="color:red">*</span></label>
                <textarea id="game-desc" class="form-textarea" placeholder="Giới thiệu sơ lược về nội dung và cách chơi..." style="min-height: 100px;" required></textarea>
            </div>

            <!-- 5. Link tải game / HTML Toggle -->
            <div class="form-group">
                <label class="form-label">Link tải game / chơi game (Google Drive, Dropbox, Itch.io...) <span style="color:red">*</span></label>
                <input type="url" id="game-link" class="form-input" placeholder="https://..." required>
            </div>
            
            <!-- Toggle for HTML Game -->
            <div class="form-group" style="flex-direction: row; align-items: center; gap: 10px;">
                <input type="checkbox" id="game-is-html" style="width: auto;">
                <label for="game-is-html" class="form-label" style="margin: 0; cursor: pointer; color: var(--text-main);">Đây là Game HTML (Chơi trực tiếp trên web)</label>
            </div>

            <!-- 6. Link video demo -->
            <div class="form-group">
                <label class="form-label">Link video demo (YouTube, Vimeo...)</label>
                <input type="url" id="game-demo" class="form-input" placeholder="https://youtube.com/watch?v=...">
            </div>

            <!-- 7. Thể loại game -->
            <div class="form-group">
                <label class="form-label">Thể loại game <span style="color:red">*</span></label>
                <select id="game-genre" class="form-select">
                    <option value="Hành động">Hành động</option>
                    <option value="Nhập vai (RPG)">Nhập vai (RPG)</option>
                    <option value="Chiến thuật">Chiến thuật</option>
                    <option value="Phiêu lưu">Phiêu lưu</option>
                    <option value="Mô phỏng">Mô phỏng</option>
                    <option value="Thể thao">Thể thao</option>
                    <option value="Parkour">Parkour</option>
                    <option value="Đua xe">Đua xe</option>
                    <option value="Khác">Khác</option>
                </select>
            </div>

            <!-- 8. Hình ảnh (Cover Image - Chọn 1) -->
            <div class="form-group">
                <label class="form-label">Ảnh bìa (Chọn 1 ảnh) <span style="color:red">*</span></label>
                <div id="cover-drop-zone" class="drop-zone">
                    <i data-lucide="image" style="margin-bottom: 10px;"></i>
                    <p>Kéo thả ảnh bìa hoặc click để chọn</p>
                    <input type="file" id="cover-input" accept="image/*" style="display: none;">
                </div>
                <div id="cover-preview" class="preview-cover-container"></div>
            </div>

            <!-- 9. Hình ảnh (Gallery Images - Chọn nhiều) -->
            <div class="form-group">
                <label class="form-label">Ảnh thư viện (Chọn nhiều ảnh, minh họa gameplay) <span style="color:red">*</span></label>
                <div id="gallery-drop-zone" class="drop-zone">
                    <i data-lucide="images" style="margin-bottom: 10px;"></i>
                    <p>Kéo thả các ảnh khác vào đây</p>
                    <input type="file" id="gallery-input" multiple accept="image/*" style="display: none;">
                </div>
                <div id="gallery-preview" class="image-preview-grid"></div>
            </div>

            <!-- 10. Ghi chú thêm -->
            <div class="form-group">
                <label class="form-label">Ghi chú thêm</label>
                <textarea id="game-notes" class="form-textarea" placeholder="Hướng dẫn cài đặt đặc biệt, cấu hình yêu cầu, v.v..." style="min-height: 80px;"></textarea>
            </div>

            <button type="submit" class="btn-submit">Đăng game</button>
        </form>
    </div>

    <!-- Community Page View (With Database) -->
    <div id="community-view" class="community-container">
        <div class="report-header">
            <h1 class="section-title" style="font-size: 24px;">Cộng đồng</h1>
            <p style="color: var(--text-muted); margin-top: 10px;">
                Chia sẻ ý kiến và thảo luận cùng mọi người.
            </p>
        </div>

        <div class="post-creator">
            <form id="post-form" class="report-form">
                <div class="form-group">
                    <label class="form-label">Tên hiển thị</label>
                    <input type="text" id="post-author" class="form-input" placeholder="Tên của bạn" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Nội dung</label>
                    <textarea id="post-content" class="form-textarea" placeholder="Bạn đang nghĩ gì?" style="min-height: 100px;" required></textarea>
                </div>
                <button type="submit" class="btn-submit">Đăng bài</button>
            </form>
        </div>

        <div id="community-feed" class="post-feed">
            <div class="loading-text">Đang tải bài viết...</div>
        </div>
    </div>

    <!-- Support Page View -->
    <div id="support-view" class="report-view" style="display: none;">
        <div class="report-header">
            <h1 class="section-title" style="font-size: 24px;">Trung tâm hỗ trợ</h1>
            <p style="color: var(--text-muted); margin-top: 10px;">
                Chào mừng bạn đến với Cửa hàng Hoi AE KHTN. Dưới đây là hướng dẫn cơ bản để bạn bắt đầu.
            </p>
        </div>
        
        <div class="support-content" style="color: var(--text-main); line-height: 1.6;">
            <div style="margin-bottom: 25px;">
                <h3 style="color: var(--accent-blue); margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                    <i data-lucide="search" size="20"></i> 1. Tìm kiếm trò chơi
                </h3>
                <p>Bạn có thể tìm kiếm trò chơi yêu thích bằng cách nhập tên vào thanh tìm kiếm ở góc trên bên phải hoặc lọc theo thể loại ở thanh menu bên trái.</p>
            </div>

            <div style="margin-bottom: 25px;">
                <h3 style="color: var(--accent-blue); margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                    <i data-lucide="mouse-pointer" size="20"></i> 2. Xem chi tiết
                </h3>
                <p>Nhấp vào bất kỳ thẻ game nào để mở cửa sổ chi tiết. Tại đây, bạn có thể xem mô tả, ảnh chụp màn hình (gallery) và thông tin phát hành.</p>
            </div>

            <div style="margin-bottom: 25px;">
                <h3 style="color: var(--accent-blue); margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                    <i data-lucide="download" size="20"></i> 3. Tải xuống
                </h3>
                <p>Trong cửa sổ chi tiết, nhấn vào nút <strong>"Tải xuống"</strong> để truy cập đường dẫn tải game (thường là Itch.io hoặc GitHub). Tất cả game trên store đều miễn phí.</p>
            </div>

            <div style="margin-bottom: 25px;">
                <h3 style="color: var(--accent-blue); margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                    <i data-lucide="flag" size="20"></i> 4. Báo cáo vấn đề
                </h3>
                <p>Nếu gặp lỗi hoặc link hỏng, vui lòng truy cập trang <strong>"Báo cáo"</strong> trên thanh menu và gửi thông tin cho chúng tôi.</p>
            </div>
        </div>
    </div>

    <!-- Report Page View -->
    <div id="report-view" class="report-view">
        <div class="report-header">
            <h1 class="section-title" style="font-size: 24px;">Báo cáo vấn đề</h1>
            <p style="color: var(--text-muted); margin-top: 10px; line-height: 1.5;">
                Hãy cho chúng tôi biết về lỗi game, nội dung không phù hợp hoặc các vấn đề khác mà bạn gặp phải.
                <br><br>
                Đóng góp của bạn giúp cộng đồng Hội AE KHTN trở nên tốt đẹp hơn. Mọi báo cáo sẽ được đội ngũ quản trị viên xem xét trong vòng 24-48 giờ. Xin cảm ơn sự hợp tác của bạn!
            </p>
        </div>
        <form class="report-form" onsubmit="submitReport(event)">
            <div class="form-group">
                <label class="form-label">Tên hiển thị</label>
                <input type="text" id="report-name" class="form-input" placeholder="Nhập tên của bạn" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Email liên hệ</label>
                <input type="email" id="report-email" class="form-input" placeholder="email@example.com" required>
            </div>

            <div class="form-group">
                <label class="form-label">Loại vấn đề</label>
                <select id="report-type" class="form-select">
                    <option value="bug">Lỗi game (Bug/Glitch)</option>
                    <option value="content">Nội dung không phù hợp</option>
                    <option value="download">Lỗi tải xuống</option>
                    <option value="other">Khác</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Mô tả chi tiết</label>
                <textarea id="report-desc" class="form-textarea" placeholder="Vui lòng mô tả chi tiết vấn đề bạn gặp phải..." required></textarea>
            </div>

            <button type="submit" class="btn-submit">Gửi báo cáo</button>
        </form>
    </div>

    <!-- Game Details Modal -->
    <div class="modal-overlay" id="game-modal">
        <div class="modal-content">
            <!-- Modal Gallery Container -->
            <div class="modal-gallery-container">
                <button class="modal-close" onclick="closeModal()"><i data-lucide="x"></i></button>
                <button class="modal-arrow left" onclick="prevModalSlide()"><i data-lucide="chevron-left"></i></button>
                <img src="" alt="Game Screenshot" class="modal-gallery-img" id="modal-gallery-img">
                <button class="modal-arrow right" onclick="nextModalSlide()"><i data-lucide="chevron-right"></i></button>
            </div>

            <div class="modal-body">
                <h1 class="modal-title" id="modal-title">null</h1>
                <div class="modal-meta" style="flex-wrap: wrap; gap: 10px;">
                    <span id="modal-genre">Hành động</span>
                    <span>|</span>
                    <span id="modal-dev" style="color: var(--text-main);">Dev: Unknown</span>
                    <span>|</span>
                    <span id="modal-release">Phát hành: 2023</span>
                </div>
                <p class="modal-desc" id="modal-desc">
                    Mô tả trò chơi sẽ xuất hiện ở đây.
                </p>
                <div class="buy-action">
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <a href="#" target="_blank" class="btn-download" id="modal-download-btn">
                            <i data-lucide="download" size="18"></i> Tải xuống
                        </a>
                        <a href="#" target="_blank" class="btn-download" id="modal-demo-btn" style="background: linear-gradient(90deg, #c0392b 5%, #8e2b21 95%); display: none;">
                            <i data-lucide="play-circle" size="18"></i> Video Demo
                        </a>
                    </div>
                    
                    <!-- Review Input Section -->
                    <div class="review-section">
                        <div class="review-input-box">
                            <h4 style="color: var(--text-main); margin-bottom: 5px;">Đánh giá trò chơi</h4>
                            <div class="star-rating" id="modal-star-input">
                                <span class="star" data-value="1">★</span>
                                <span class="star" data-value="2">★</span>
                                <span class="star" data-value="3">★</span>
                                <span class="star" data-value="4">★</span>
                                <span class="star" data-value="5">★</span>
                            </div>
                            <input type="text" id="review-username" class="form-input" placeholder="Tên của bạn" style="padding: 8px;">
                            <textarea id="review-comment" class="form-textarea" placeholder="Viết bình luận của bạn..." style="min-height: 80px; padding: 8px;"></textarea>
                            <button class="btn-review" onclick="submitReview()">Gửi đánh giá</button>
                        </div>
                    </div>
                </div>

                <!-- Reviews List -->
                <div id="modal-reviews-list" class="reviews-list">
                    <!-- Reviews will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, arrayUnion, arrayRemove, increment, getDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE SETUP ---
        // Using your specific configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCqyEB-WagVK1bInuz7EAzb8q96yt7j1ww",
            authDomain: "hoi-ae-store.firebaseapp.com",
            projectId: "hoi-ae-store",
            storageBucket: "hoi-ae-store.firebasestorage.app",
            messagingSenderId: "618880423826",
            appId: "1:618880423826:web:e13227cbeebd3627b9534b",
            measurementId: "G-SSDSFNVC18"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        // Using a static App ID for data organization within your project
        const appId = 'hoi-ae-store-v1';
        
        let currentUser = null;
        let isFirebaseAvailable = true;
        let globalReviews = []; // Store all reviews to filter locally

        // Initialize Auth
        async function initAuth() {
            if (!isFirebaseAvailable) return;
            try {
                // Try anonymous sign-in directly since we are running locally/web
                await signInAnonymously(auth);
                
                currentUser = auth.currentUser;
                // Start listening to posts and games only after auth
                loadCommunityPosts();
                loadUserGames();
                loadAllReviews(); // Load reviews
            } catch (error) {
                console.error("Auth failed", error);
            }
        }
        initAuth();

        // --- DRAG & DROP LOGIC ---
        // Separate variables for Cover and Gallery
        let uploadedCover = null;
        let uploadedGallery = [];

        // Cover Zone
        const coverDropZone = document.getElementById('cover-drop-zone');
        const coverInput = document.getElementById('cover-input');
        const coverPreview = document.getElementById('cover-preview');

        if (coverDropZone) {
            coverDropZone.addEventListener('click', () => coverInput.click());
            coverDropZone.addEventListener('dragover', (e) => { e.preventDefault(); coverDropZone.classList.add('dragover'); });
            coverDropZone.addEventListener('dragleave', () => coverDropZone.classList.remove('dragover'));
            coverDropZone.addEventListener('drop', (e) => { e.preventDefault(); coverDropZone.classList.remove('dragover'); handleCoverFile(e.dataTransfer.files); });
            coverInput.addEventListener('change', () => handleCoverFile(coverInput.files));
        }

        function handleCoverFile(files) {
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        uploadedCover = e.target.result;
                        renderCoverPreview();
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        function renderCoverPreview() {
            if (uploadedCover) {
                coverPreview.innerHTML = `
                    <div class="preview-item">
                        <img src="${uploadedCover}" class="preview-img">
                        <button type="button" class="remove-img" onclick="removeCoverImage()">x</button>
                    </div>`;
            } else {
                coverPreview.innerHTML = '';
            }
        }

        window.removeCoverImage = function() {
            uploadedCover = null;
            renderCoverPreview();
        }

        // Gallery Zone
        const galleryDropZone = document.getElementById('gallery-drop-zone');
        const galleryInput = document.getElementById('gallery-input');
        const galleryPreview = document.getElementById('gallery-preview');

        if (galleryDropZone) {
            galleryDropZone.addEventListener('click', () => galleryInput.click());
            galleryDropZone.addEventListener('dragover', (e) => { e.preventDefault(); galleryDropZone.classList.add('dragover'); });
            galleryDropZone.addEventListener('dragleave', () => galleryDropZone.classList.remove('dragover'));
            galleryDropZone.addEventListener('drop', (e) => { e.preventDefault(); galleryDropZone.classList.remove('dragover'); handleGalleryFiles(e.dataTransfer.files); });
            galleryInput.addEventListener('change', () => handleGalleryFiles(galleryInput.files));
        }

        function handleGalleryFiles(files) {
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        uploadedGallery.push(e.target.result);
                        renderGalleryPreview();
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function renderGalleryPreview() {
            galleryPreview.innerHTML = uploadedGallery.map((src, index) => `
                <div class="preview-item">
                    <img src="${src}" class="preview-img">
                    <button type="button" class="remove-img" onclick="removeGalleryImage(${index})">x</button>
                </div>
            `).join('');
        }

        window.removeGalleryImage = function(index) {
            uploadedGallery.splice(index, 1);
            renderGalleryPreview();
        }

        // --- REVIEWS LOGIC ---
        let currentRating = 0;
        
        // Star Rating Interaction
        const starContainer = document.getElementById('modal-star-input');
        if(starContainer) {
            const stars = starContainer.querySelectorAll('.star');
            stars.forEach(star => {
                star.addEventListener('click', () => {
                    currentRating = parseInt(star.getAttribute('data-value'));
                    updateStarVisuals(currentRating);
                });
            });
        }

        function updateStarVisuals(rating) {
            const stars = document.querySelectorAll('#modal-star-input .star');
            stars.forEach(s => {
                const val = parseInt(s.getAttribute('data-value'));
                if (val <= rating) s.classList.add('active');
                else s.classList.remove('active');
            });
        }

        // Load All Reviews (Rule 2: Fetch all, filter locally)
        function loadAllReviews() {
            const reviewsRef = collection(db, 'artifacts', appId, 'public', 'data', 'game_reviews');
            onSnapshot(reviewsRef, (snapshot) => {
                globalReviews = [];
                snapshot.forEach(doc => {
                    globalReviews.push({ id: doc.id, ...doc.data() });
                });
                // If modal is open, refresh reviews
                if (selectedGame && document.getElementById('game-modal').classList.contains('open')) {
                    renderReviewsForGame(selectedGame.id);
                }
            });
        }

        function renderReviewsForGame(gameId) {
            const container = document.getElementById('modal-reviews-list');
            // Filter reviews for this gameId
            // Ensure ID comparison is safe (string vs number)
            const gameReviews = globalReviews.filter(r => String(r.gameId) === String(gameId));
            
            // Sort by newst
            gameReviews.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

            if (gameReviews.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">Chưa có đánh giá nào. Hãy là người đầu tiên!</div>';
                return;
            }

            container.innerHTML = gameReviews.map(review => {
                const stars = '★'.repeat(review.rating) + '☆'.repeat(5 - review.rating);
                return `
                <div class="user-review-item">
                    <div class="review-header">
                        <span class="review-author">${escapeHtml(review.userName)}</span>
                        <span class="review-stars">${stars}</span>
                    </div>
                    <div style="color: var(--text-main); font-size: 14px;">${escapeHtml(review.comment)}</div>
                    <div style="color: var(--text-muted); font-size: 11px; margin-top: 5px;">${new Date(review.timestamp).toLocaleDateString('vi-VN')}</div>
                </div>`;
            }).join('');
        }

        window.submitReview = async function() {
            if (!currentUser) { alert("Vui lòng đợi kết nối..."); return; }
            if (!selectedGame) return;
            
            const username = document.getElementById('review-username').value;
            const comment = document.getElementById('review-comment').value;

            if (!username.trim() || !comment.trim() || currentRating === 0) {
                alert("Vui lòng chọn số sao, nhập tên và nội dung bình luận.");
                return;
            }

            const btn = document.querySelector('.btn-review');
            btn.disabled = true;
            btn.innerText = "Đang gửi...";

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'game_reviews'), {
                    gameId: String(selectedGame.id), // Store as string for consistency
                    userId: currentUser.uid,
                    userName: username,
                    rating: currentRating,
                    comment: comment,
                    timestamp: Date.now()
                });
                
                // Reset form
                document.getElementById('review-username').value = '';
                document.getElementById('review-comment').value = '';
                currentRating = 0;
                updateStarVisuals(0);
                
            } catch (error) {
                console.error("Review failed:", error);
                alert("Lỗi khi gửi đánh giá.");
            } finally {
                btn.disabled = false;
                btn.innerText = "Gửi đánh giá";
            }
        }


        // Load Posts Real-time
        function loadCommunityPosts() {
            if (!currentUser) {
                const postsContainer = document.getElementById('community-feed');
                if (postsContainer) postsContainer.innerHTML = '<div class="loading-text">Đang kết nối...</div>';
                return;
            }
            
            const postsContainer = document.getElementById('community-feed');
            const postsRef = collection(db, 'artifacts', appId, 'public', 'data', 'community_posts');

            onSnapshot(postsRef, (snapshot) => {
                const posts = [];
                snapshot.forEach(doc => {
                    posts.push({ id: doc.id, ...doc.data() });
                });

                posts.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                if (posts.length === 0) {
                    postsContainer.innerHTML = '<div class="loading-text">Chưa có bài viết nào. Hãy là người đầu tiên!</div>';
                    return;
                }

                postsContainer.innerHTML = posts.map(post => {
                    const upvotes = post.upvotes || 0;
                    const downvotes = post.downvotes || 0;
                    const score = upvotes - downvotes;
                    const replies = post.replies || [];
                    
                    const isUpvoted = post.upvotedBy && post.upvotedBy.includes(currentUser.uid);
                    const isDownvoted = post.downvotedBy && post.downvotedBy.includes(currentUser.uid);
                    
                    return `
                    <div class="community-post">
                        <div class="post-header">
                            <span class="post-author">${escapeHtml(post.author)}</span>
                            <span>${new Date(post.timestamp).toLocaleString('vi-VN')}</span>
                        </div>
                        <div class="post-content">${escapeHtml(post.content)}</div>
                        
                        <div class="post-actions">
                            <div class="vote-group">
                                <button class="vote-btn ${isUpvoted ? 'active' : ''}" onclick="window.votePost('${post.id}', 'up')" title="Upvote">
                                    <i data-lucide="chevron-up"></i>
                                </button>
                                <span class="vote-count" style="color: ${score > 0 ? '#a4d007' : (score < 0 ? '#ff4d4d' : 'inherit')}">${score}</span>
                                <button class="vote-btn down ${isDownvoted ? 'active' : ''}" onclick="window.votePost('${post.id}', 'down')" title="Downvote">
                                    <i data-lucide="chevron-down"></i>
                                </button>
                            </div>
                            <button class="reply-btn" onclick="window.toggleReply('${post.id}')">
                                <i data-lucide="message-circle" size="16"></i> Trả lời (${replies.length})
                            </button>
                        </div>

                        <div class="replies-section">
                            ${replies.map(r => `
                                <div class="reply-item">
                                    <div class="post-header" style="margin-bottom: 5px;">
                                        <span class="post-author" style="font-size: 13px;">${escapeHtml(r.author)}</span>
                                        <span style="font-size: 11px;">${new Date(r.timestamp).toLocaleDateString('vi-VN')}</span>
                                    </div>
                                    <div class="post-content" style="font-size: 14px;">${escapeHtml(r.content)}</div>
                                </div>
                            `).join('')}
                            
                            <div id="reply-form-${post.id}" class="reply-form">
                                <input type="text" id="reply-author-${post.id}" class="form-input" placeholder="Tên của bạn" style="padding: 8px;">
                                <textarea id="reply-content-${post.id}" class="form-textarea" placeholder="Viết phản hồi của bạn..." style="min-height: 60px; padding: 8px;"></textarea>
                                <div style="display:flex; justify-content: flex-end; gap: 10px;">
                                    <button class="btn-submit" style="margin-top:0; padding: 8px 15px; font-size: 13px; background: #2a475e;" onclick="window.toggleReply('${post.id}')">Hủy</button>
                                    <button class="btn-submit" style="margin-top:0; padding: 8px 15px; font-size: 13px;" onclick="window.submitReply('${post.id}')">Gửi</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `}).join('');
                
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }, (error) => {
                console.error("Error loading posts:", error);
            });
        }

        // Vote Function
        window.votePost = async function(postId, type) {
            if (!currentUser) { alert("Vui lòng đợi kết nối..."); return; }
            
            const postRef = doc(db, 'artifacts', appId, 'public', 'data', 'community_posts', postId);
            const uid = currentUser.uid;

            try {
                const postSnap = await getDoc(postRef);
                if (!postSnap.exists()) return;
                
                const post = postSnap.data();
                const upvotedBy = post.upvotedBy || [];
                const downvotedBy = post.downvotedBy || [];

                if (type === 'up') {
                    if (upvotedBy.includes(uid)) {
                        await updateDoc(postRef, {
                            upvotedBy: arrayRemove(uid),
                            upvotes: increment(-1)
                        });
                    } else if (downvotedBy.includes(uid)) {
                        await updateDoc(postRef, {
                            downvotedBy: arrayRemove(uid),
                            downvotes: increment(-1),
                            upvotedBy: arrayUnion(uid),
                            upvotes: increment(1)
                        });
                    } else {
                        await updateDoc(postRef, {
                            upvotedBy: arrayUnion(uid),
                            upvotes: increment(1)
                        });
                    }
                } else { // type === 'down'
                    if (downvotedBy.includes(uid)) {
                        await updateDoc(postRef, {
                            downvotedBy: arrayRemove(uid),
                            downvotes: increment(-1)
                        });
                    } else if (upvotedBy.includes(uid)) {
                        await updateDoc(postRef, {
                            upvotedBy: arrayRemove(uid),
                            upvotes: increment(-1),
                            downvotedBy: arrayUnion(uid),
                            downvotes: increment(1)
                        });
                    } else {
                        await updateDoc(postRef, {
                            downvotedBy: arrayUnion(uid),
                            downvotes: increment(1)
                        });
                    }
                }
            } catch (error) {
                console.error("Vote failed:", error);
            }
        }

        window.toggleReply = function(postId) {
            const form = document.getElementById(`reply-form-${postId}`);
            if (form) form.classList.toggle('open');
        }

        window.submitReply = async function(postId) {
            if (!currentUser) return;
            
            const authorInput = document.getElementById(`reply-author-${postId}`);
            const contentInput = document.getElementById(`reply-content-${postId}`);
            
            if (!authorInput.value.trim() || !contentInput.value.trim()) {
                alert("Vui lòng nhập tên và nội dung phản hồi.");
                return;
            }

            const postRef = doc(db, 'artifacts', appId, 'public', 'data', 'community_posts', postId);
            const newReply = {
                author: authorInput.value,
                content: contentInput.value,
                timestamp: Date.now(),
                userId: currentUser.uid
            };

            try {
                await updateDoc(postRef, {
                    replies: arrayUnion(newReply)
                });
                contentInput.value = '';
                window.toggleReply(postId);
            } catch (error) {
                console.error("Reply failed:", error);
                alert("Lỗi khi gửi phản hồi.");
            }
        }

        // Load Uploaded Games Real-time
        function loadUserGames() {
            if (!currentUser) return;
            const gamesRef = collection(db, 'artifacts', appId, 'public', 'data', 'uploaded_games');

            onSnapshot(gamesRef, (snapshot) => {
                let uploadedGames = [];
                snapshot.forEach(doc => {
                    uploadedGames.push({ id: doc.id, ...doc.data(), isUploaded: true });
                });
                
                allGames = [...staticGames, ...uploadedGames];
                
                window.renderFeatured();
                window.filterByGenre(currentFilter);
                
            }, (error) => {
                console.error("Error loading games:", error);
            });
        }

        // Submit Post
        window.submitPost = async function(e) {
            e.preventDefault();
            const authorInput = document.getElementById('post-author');
            const contentInput = document.getElementById('post-content');
            const btn = e.target.querySelector('button');

            if (!authorInput.value.trim() || !contentInput.value.trim()) return;
            if (!currentUser) {
                alert("Đang kết nối database...");
                return;
            }

            btn.disabled = true;
            btn.innerText = "Đang đăng...";

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'community_posts'), {
                    author: authorInput.value,
                    content: contentInput.value,
                    timestamp: Date.now(),
                    userId: currentUser.uid
                });
                contentInput.value = '';
            } catch (error) {
                console.error("Error posting:", error);
                alert("Lỗi khi đăng bài. Vui lòng thử lại.");
            } finally {
                btn.disabled = false;
                btn.innerText = "Đăng bài";
            }
        }

        // Submit Game
        window.submitGame = async function(e) {
            e.preventDefault();
            
            const developer = document.getElementById('game-dev').value;
            const email = document.getElementById('game-email').value;
            const title = document.getElementById('game-title').value;
            const desc = document.getElementById('game-desc').value;
            const downloadLink = document.getElementById('game-link').value;
            const demoLink = document.getElementById('game-demo').value;
            const genre = document.getElementById('game-genre').value;
            const notes = document.getElementById('game-notes').value;
            const isHtmlGame = document.getElementById('game-is-html').checked;
            
            // Check files first
            if (!uploadedCover) {
                alert("Vui lòng tải lên ảnh bìa!");
                return;
            }
            if (uploadedGallery.length === 0) {
                 // Warning only, can proceed without gallery if needed, but lets enforce it for quality
                 alert("Vui lòng tải lên ít nhất 1 ảnh thư viện!");
                 return;
            }

            const btn = e.target.querySelector('button');

            if (!currentUser) {
                alert("Đang kết nối database...");
                return;
            }

            btn.disabled = true;
            btn.innerText = "Đang xử lý...";

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'uploaded_games'), {
                    developer: developer,
                    email: email,
                    title: title,
                    desc: desc,
                    downloadUrl: downloadLink,
                    demoUrl: demoLink,
                    genre: genre,
                    image: uploadedCover, // Single Cover
                    gallery: uploadedGallery, // Array of Gallery
                    notes: notes,
                    isHtmlGame: isHtmlGame,
                    releaseDate: new Date().toISOString().split('T')[0],
                    timestamp: Date.now(),
                    userId: currentUser.uid
                });
                
                alert("Đăng game thành công! Game của bạn đã xuất hiện trên cửa hàng.");
                e.target.reset();
                uploadedCover = null;
                uploadedGallery = [];
                renderCoverPreview();
                renderGalleryPreview();
                window.switchPage('store', document.querySelector('.nav-link'));
            } catch (error) {
                console.error("Error submitting game:", error);
                alert("Lỗi khi đăng game. Vui lòng thử lại (Ảnh có thể quá nặng).");
            } finally {
                btn.disabled = false;
                btn.innerText = "Đăng game";
            }
        }

        // Submit Report
        window.submitReport = async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('report-name').value;
            const email = document.getElementById('report-email').value;
            const type = document.getElementById('report-type').value;
            const desc = document.getElementById('report-desc').value;
            
            const btn = e.target.querySelector('button');

            if (!currentUser) {
                alert("Đang kết nối database...");
                return;
            }

            btn.disabled = true;
            btn.innerText = "Đang gửi...";

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'reports'), {
                    reporterName: name,
                    reporterEmail: email,
                    issueType: type,
                    description: desc,
                    timestamp: Date.now(),
                    userId: currentUser.uid
                });
                
                alert('Cảm ơn bạn đã báo cáo! Chúng tôi sẽ xem xét sớm nhất.');
                e.target.reset();
                window.switchPage('store', document.querySelector('.nav-link'));
            } catch (error) {
                console.error("Error submitting report:", error);
                alert("Lỗi khi gửi báo cáo. Vui lòng thử lại.");
            } finally {
                btn.disabled = false;
                btn.innerText = "Gửi báo cáo";
            }
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        const postForm = document.getElementById('post-form');
        if(postForm) {
            postForm.addEventListener('submit', window.submitPost);
        }

        /* --- STANDARD JS Logic --- */
        
        window.formatGameDate = function(dateString) {
            if (!dateString) return "TBA";
            const date = new Date(dateString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        // Static Data 
        const staticGames = [
            {
                id: 1,
                title: "Racing Racing",
                genre: "Đua xe",
                image: "Images/preset/racingracing/Untitled.jpg", 
                gallery: [
                    "Images/preset/racingracing/aE66.png", 
                    "Images/preset/racingracing/azFzls.png", 
                    "Images/preset/racingracing/Dd34vH.png",
                    "Images/preset/racingracing/MyCaeM.png",
                    "Images/preset/racingracing/tdvU_j.png",
                    "Images/preset/racingracing/uLRTK8.png"
                ],
                // USE BACKTICKS (`) to write on multiple lines easily like this:
                desc: `RacingRacing Unity 3D
How to Play?
- Use Arrow Keys or WASD to move
- Press Left Shift to break
- Press Space to horn
- Press Esc to display the Pause Panel
About Game:
- This is a part of my group's project for the end of the term
- Student: Truong Phat Huy
- Group: Hoi Ae Yeu KHTN
- From: University of Science - Ho Chi Minh Vietnam National University
Play Game for fun!`,
                featured: true,
                downloadUrl: "https://itchio-mirror.cb031a832f44726753d6267436f3b414.r2.cloudflarestorage.com/upload2/game/4132387/15889212?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=3edfcce40115d057d0b5606758e7e9ee%2F20251220%2Fauto%2Fs3%2Faws4_request&X-Amz-Date=20251220T103410Z&X-Amz-Expires=60&X-Amz-SignedHeaders=host&X-Amz-Signature=d3a600bc3f527de65a075d60f3ef81e8166b72fcf1e1fe76548f96ca9718ed3f",
                releaseDate: "2025-12-19"
            },
            {
                id: 2,
                title: "Game 2",
                genre: "Hành động",
                image: "https://placehold.co/600x400/2b2005/2b2005.png",
                gallery: [
                    "https://placehold.co/800x400/2b2005/ffffff.png?text=Action+1",
                    "https://placehold.co/800x400/4a3810/ffffff.png?text=Action+2"
                ],
                desc: "Trỗi dậy, Kẻ bị lu mờ, và được dẫn dắt bởi ân sủng.",
                featured: true,
                downloadUrl: "https://github.com",
                releaseDate: "2024-02-25"
            },
            {
                id: 3,
                title: "Game 3",
                genre: "Mô phỏng",
                image: "https://placehold.co/600x400/000033/000033.png",
                gallery: [
                    "https://placehold.co/800x400/000033/ffffff.png?text=Space+1"
                ],
                desc: "Khám phá dải ngân hà, giao thương với các nền văn minh ngoài hành tinh.",
                featured: false,
                downloadUrl: "https://itch.io",
                releaseDate: "2023-11-15"
            },
            {
                id: 4,
                title: "Game 4",
                genre: "Phiêu lưu",
                image: "https://placehold.co/600x400/4a0e0e/4a0e0e.png",
                gallery: [
                    "https://placehold.co/800x400/4a0e0e/ffffff.png"
                ],
                desc: "Một trò chơi khám phá hầm ngục lấy cảm hứng cổ điển.",
                featured: false,
                downloadUrl: "https://itch.io",
                releaseDate: "2024-05-01"
            },
            {
                id: 5,
                title: "Game 5",
                genre: "Thể thao",
                image: "https://placehold.co/600x400/990000/990000.png",
                gallery: [
                    "https://placehold.co/800x400/990000/ffffff.png"
                ],
                desc: "Trò chơi mô phỏng đua xe đỉnh cao.",
                featured: false,
                downloadUrl: "https://itch.io",
                releaseDate: "2024-08-20"
            },
            {
                id: 6,
                title: "Game 6",
                genre: "Chiến thuật",
                image: "https://placehold.co/600x400/1a1a1a/1a1a1a.png",
                gallery: [
                    "https://placehold.co/800x400/1a1a1a/ffffff.png"
                ],
                desc: "Chiến thuật lén lút hạng nặng lấy bối cảnh Nhật Bản cổ đại.",
                featured: false,
                downloadUrl: "https://itch.io",
                releaseDate: "2023-03-10"
            },
            {
                id: 7,
                title: "Game 7",
                genre: "Hành động",
                image: "https://placehold.co/600x400/2e3b23/2e3b23.png",
                gallery: [
                    "https://placehold.co/800x400/2e3b23/ffffff.png"
                ],
                desc: "Sống sót qua ngày tận thế cùng bạn bè.",
                featured: true,
                downloadUrl: "https://itch.io",
                releaseDate: "2024-10-31"
            },
            {
                id: 8,
                title: "Game 8",
                genre: "Mô phỏng",
                image: "https://placehold.co/600x400/3e5c26/3e5c26.png",
                gallery: [
                    "https://placehold.co/800x400/3e5c26/ffffff.png"
                ],
                desc: "Thư giãn và phát triển trang trại của bạn.",
                featured: false,
                downloadUrl: "https://itch.io",
                releaseDate: "2023-06-15"
            },
            {
                id: 9,
                title: "Game 9",
                genre: "Nhập vai (RPG)",
                image: "https://placehold.co/600x400/220044/220044.png",
                gallery: [
                    "https://placehold.co/800x400/220044/ffffff.png"
                ],
                desc: "Du hành qua hư không và chiến đấu với nỗi kinh hoàng.",
                featured: false,
                downloadUrl: "https://itch.io",
                releaseDate: "2024-01-01"
            },
            {
                id: 10,
                title: "Game 10",
                genre: "Phiêu lưu",
                image: "https://placehold.co/600x400/3c8e22/3c8e22.png",
                gallery: [
                    "https://placehold.co/800x400/3c8e22/ffffff.png"
                ],
                desc: "Xây dựng bất cứ thứ gì bạn có thể tưởng tượng.",
                featured: false,
                downloadUrl: "https://itch.io",
                releaseDate: "2023-12-25"
            },
            {
                id: 11,
                title: "Game 11",
                genre: "Chiến thuật",
                image: "https://placehold.co/600x400/440000/440000.png",
                gallery: [
                    "https://placehold.co/800x400/440000/ffffff.png"
                ],
                desc: "Chỉ huy các đội quân khổng lồ ở châu Âu.",
                featured: false,
                downloadUrl: "https://itch.io",
                releaseDate: "2024-07-14"
            },
            {
                id: 12,
                title: "Game 12",
                genre: "Thể thao",
                image: "https://placehold.co/600x400/000000/000000.png",
                gallery: [
                    "https://placehold.co/800x400/000000/ffffff.png"
                ],
                desc: "Trò chơi pong tương lai với vật lý.",
                featured: false,
                downloadUrl: "https://itch.io",
                releaseDate: "2024-09-09"
            }
        ];

        let allGames = [...staticGames];
        let currentFilter = 'All';
        let selectedGame = null;
        let currentModalImageIndex = 0;
        
        // DOM Elements
        const grid = document.getElementById('games-grid');
        const featuredContainer = document.getElementById('featured-carousel');
        const searchInput = document.getElementById('search-input');
        const modal = document.getElementById('game-modal');
        
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            } else {
                console.error("Lucide library failed to load.");
            }
            renderFeatured();
            renderGames(allGames);
        });

        // Global functions for HTML interaction
        window.renderFeatured = function() {
            const featuredGames = allGames.filter(g => g.featured);
            featuredContainer.innerHTML = featuredGames.map((game, index) => `
                <div class="featured-slide ${index === 0 ? 'active' : ''}" style="z-index: ${featuredGames.length - index}" onclick="openModal('${game.id}')">
                    <img src="${game.image}" class="featured-image" alt="${game.title}">
                    <div class="featured-info">
                        <div>
                            <div class="featured-title">${game.title}</div>
                            <div class="featured-tags">
                                <span class="tag">Được yêu thích nhất</span>
                                <span class="tag">${game.genre}</span>
                            </div>
                        </div>
                        <div class="featured-desc">${game.desc}</div>
                    </div>
                </div>
            `).join('');

            // Auto rotation logic needs to re-select elements
            if (window.carouselInterval) clearInterval(window.carouselInterval);
            
            window.carouselInterval = setInterval(() => {
                const slides = document.querySelectorAll('.featured-slide');
                if (slides.length === 0) return;
                
                let activeIndex = -1;
                slides.forEach((s, i) => {
                    if (s.classList.contains('active')) activeIndex = i;
                    s.classList.remove('active');
                });
                
                let nextIndex = (activeIndex + 1) % slides.length;
                slides[nextIndex].classList.add('active');
            }, 5000);
        }

        window.renderGames = function(gamesList) {
            grid.innerHTML = gamesList.map(game => `
                <div class="game-card" onclick="openModal('${game.id}')">
                    <div class="card-image-container">
                        <img src="${game.image}" class="card-image" alt="${game.title}" onerror="this.src='https://placehold.co/600x400/333/fff?text=No+Image'">
                    </div>
                    <div class="game-info">
                        <div class="game-title">${game.title}</div>
                        <div class="game-tags">${game.genre}</div>
                    </div>
                </div>
            `).join('');
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        window.filterByGenre = function(genre) {
            currentFilter = genre;
            document.getElementById('current-genre').innerText = genre === 'All' ? 'Tất cả sản phẩm' : genre;
            
            document.querySelectorAll('.filter-option').forEach(el => {
                el.classList.remove('active');
                if(el.innerText.includes(genre)) el.classList.add('active');
            });

            applyFilters();
        }

        function applyFilters() {
            let filtered = allGames;
            if (currentFilter !== 'All') {
                filtered = filtered.filter(g => g.genre === currentFilter);
            }
            const term = searchInput.value.toLowerCase();
            if (term) {
                filtered = filtered.filter(g => g.title.toLowerCase().includes(term));
            }
            renderGames(filtered);
        }

        searchInput.addEventListener('input', applyFilters);

        window.openModal = function(id) {
            selectedGame = allGames.find(g => g.id == id);
            if (!selectedGame) return;
            
            currentModalImageIndex = 0; 
            
            document.getElementById('modal-title').innerText = selectedGame.title;
            document.getElementById('modal-genre').innerText = selectedGame.genre;
            
            const devText = selectedGame.developer ? `Nhà phát triển: ${selectedGame.developer}` : "Nhà phát triển: Hoi AE KHTN";
            document.getElementById('modal-dev').innerText = devText;

            let fullDesc = selectedGame.desc;
            if (selectedGame.notes) {
                fullDesc += `\n\n--- Ghi chú thêm ---\n${selectedGame.notes}`;
            }
            document.getElementById('modal-desc').innerText = fullDesc;
            
            // Re-use currentRating if previously set, or reset
            currentRating = 0;
            updateStarVisuals(0);
            
            const releaseDate = formatGameDate(selectedGame.releaseDate);
            document.getElementById('modal-release').innerText = `Phát hành: ${releaseDate}`;
            
            const downloadBtn = document.getElementById('modal-download-btn');
            if (selectedGame.downloadUrl) {
                downloadBtn.href = selectedGame.downloadUrl;
                downloadBtn.style.display = 'inline-flex';
                
                if (selectedGame.isHtmlGame) {
                    downloadBtn.innerHTML = '<i data-lucide="play" size="18"></i> Chơi ngay';
                    downloadBtn.style.background = 'linear-gradient(90deg, #75b022 5%, #588a1b 95%)'; // Green
                } else {
                    downloadBtn.innerHTML = '<i data-lucide="download" size="18"></i> Tải xuống';
                    downloadBtn.style.background = ''; // Reset to default blue
                }
            } else {
                downloadBtn.style.display = 'none';
            }

            const demoBtn = document.getElementById('modal-demo-btn');
            if (selectedGame.demoUrl) {
                demoBtn.href = selectedGame.demoUrl;
                demoBtn.style.display = 'inline-flex';
            } else {
                demoBtn.style.display = 'none';
            }
            
            renderReviewsForGame(id);

            updateModalGallery();
            modal.classList.add('open');
            document.body.style.overflow = 'hidden'; 
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        window.updateModalGallery = function() {
            const images = selectedGame.gallery || [selectedGame.image];
            const imgElement = document.getElementById('modal-gallery-img');
            imgElement.src = images[currentModalImageIndex];
        }

        window.nextModalSlide = function() {
            if (!selectedGame) return;
            const images = selectedGame.gallery || [selectedGame.image];
            currentModalImageIndex = (currentModalImageIndex + 1) % images.length;
            updateModalGallery();
        }

        window.prevModalSlide = function() {
            if (!selectedGame) return;
            const images = selectedGame.gallery || [selectedGame.image];
            currentModalImageIndex = (currentModalImageIndex - 1 + images.length) % images.length;
            updateModalGallery();
        }

        window.closeModal = function() {
            modal.classList.remove('open');
            document.body.style.overflow = 'auto';
        }

        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        window.switchPage = function(page, element) {
            document.getElementById('store-view').style.display = 'none';
            document.getElementById('report-view').style.display = 'none';
            document.getElementById('support-view').style.display = 'none';
            document.getElementById('community-view').style.display = 'none';
            document.getElementById('upload-view').style.display = 'none';
            
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            
            if(page === 'store') {
                document.getElementById('store-view').style.display = 'grid';
            } else if (page === 'report') {
                document.getElementById('report-view').style.display = 'block';
            } else if (page === 'support') {
                document.getElementById('support-view').style.display = 'block';
            } else if (page === 'community') {
                document.getElementById('community-view').style.display = 'block';
            } else if (page === 'upload') {
                document.getElementById('upload-view').style.display = 'block';
            }
            
            if(element) element.classList.add('active');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        window.submitReport = function(e) {
            e.preventDefault();
            alert('Cảm ơn bạn đã báo cáo! Chúng tôi sẽ xem xét sớm nhất.');
            e.target.reset(); 
            window.switchPage('store', document.querySelector('.nav-link')); 
        }

    </script>
</body>
</html>